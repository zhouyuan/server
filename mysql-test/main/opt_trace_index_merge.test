--disable_warnings
DROP TABLE IF EXISTS t1,t2,t3,t4;
DROP DATABASE IF EXISTS world;
--enable_warnings

set names utf8;

CREATE DATABASE world;

use world;

--source include/world_schema.inc

--disable_query_log
--disable_result_log
--disable_warnings
--source include/world.inc
--enable_warnings
--enable_result_log
--enable_query_log

SELECT COUNT(*) FROM Country;
SELECT COUNT(*) FROM City;
SELECT COUNT(*) FROM CountryLanguage;

CREATE INDEX Name ON City(Name);

--disable_query_log
--disable_result_log
--disable_warnings
ANALYZE TABLE City;
--enable_warnings
--enable_result_log
--enable_query_log

SET SESSION optimizer_switch='index_merge_sort_intersection=on';

SELECT COUNT(*) FROM City;

# The output of the next 6 queries tells us about selectivities
# of the conditions utilized in 4 queries following after them  

set optimizer_trace="enabled=on,one_line=off";

--echo # using sort_intersect
EXPLAIN
SELECT * FROM City WHERE
  Name LIKE 'C%' AND Population > 1000000;
select * from information_schema.OPTIMIZER_TRACE;

--echo # using sort_union
EXPLAIN
SELECT * FROM City WHERE
  Name LIKE 'C%' OR Population > 1000000;
select * from information_schema.OPTIMIZER_TRACE;

drop database world;

--echo # using union
use test;
create table t0 (a int);
insert into t0 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);
create table t1 (a int, b int, c int, filler char(100),
                 key(a), key(b), key(c));
insert into t1 select
  A.a * B.a*10 + C.a*100,
  A.a * B.a*10 + C.a*100,
  A.a,
  'filler'
from t0 A, t0 B, t0 C;

--echo This should use union:
explain select * from t1 where a=1 or b=1;
select * from information_schema.OPTIMIZER_TRACE;
drop table t0,t1;
