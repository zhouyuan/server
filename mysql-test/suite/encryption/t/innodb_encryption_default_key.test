-- source include/have_innodb.inc
-- source include/have_file_key_management_plugin.inc
-- source include/not_embedded.inc

call mtr.add_suppression("innodb_default_encryption_key_id=999 is unavailable in the encryption plugin");
call mtr.add_suppression("Plugin 'InnoDB' init function returned error.");
call mtr.add_suppression("Plugin 'InnoDB' registration as a STORAGE ENGINE failed.");

--disable_query_log
let $innodb_file_format_orig = `SELECT @@innodb_file_format`;
let $innodb_file_per_table_orig = `SELECT @@innodb_file_per_table`;
--enable_query_log

--disable_warnings
SET GLOBAL innodb_file_format = `Barracuda`;
SET GLOBAL innodb_file_per_table = ON;
--enable_warnings

create table t1 (a int not null primary key) engine=InnoDB;
create table t2 (a int not null primary key) encrypted=yes engine=InnoDB;

#
# Test limits
#
--error ER_WRONG_VALUE_FOR_VAR
SET GLOBAL innodb_default_encryption_key_id = -1;
SHOW WARNINGS;
--error ER_WRONG_VALUE_FOR_VAR
SET GLOBAL innodb_default_encryption_key_id = 4294967296;
SHOW WARNINGS;
--error ER_WRONG_TYPE_FOR_VAR
SET GLOBAL innodb_default_encryption_key_id = 'k';
SHOW WARNINGS;

# Do not allow setting default key to key_id that is not found
--error ER_WRONG_VALUE_FOR_VAR
SET GLOBAL innodb_default_encryption_key_id = 999;
SHOW WARNINGS;

SET GLOBAL innodb_default_encryption_key_id = 4;
SET GLOBAL innodb_encryption_threads = 4;
SET GLOBAL innodb_encrypt_tables = ON;

--connect (con11,localhost,root,,test)
SET SESSION innodb_default_encryption_key_id = 2;
create table t3 (a int not null primary key) engine=InnoDB;
create table t4 (a int not null primary key) encrypted=yes engine=InnoDB;
--disconnect con11

--connect (con12,localhost,root,,test)
SET SESSION innodb_default_encryption_key_id = 10;
create table t5 (a int not null primary key) engine=InnoDB;
create table t6 (a int not null primary key) encrypted=yes engine=InnoDB;
--disconnect con12

--connection default
--let $tables_count= `select count(*) from information_schema.tables where engine = 'InnoDB'`
--let $wait_condition=SELECT COUNT(*) = $tables_count + 1 FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0 AND ROTATING_OR_FLUSHING = 0;
--source include/wait_condition.inc

SELECT NAME,CURRENT_KEY_ID,MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0 ORDER BY NAME;
SELECT NAME,CURRENT_KEY_ID,MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0 ORDER BY NAME;

--echo # Success!

DROP TABLE t1, t2, t3, t4, t5, t6;

#
# Try to restart server with key_id that is not found from encryption plugin
#
--echo # Restart mysqld --innodb_default_encryption_key_id=999
-- let $restart_parameters=--innodb_default_encryption_key_id=999
--error 1
-- source include/restart_mysqld.inc

--echo # Restart mysqld --innodb_default_encryption_key_id=1
-- let $restart_parameters=--innodb_default_encryption_key_id=1
--error 1
-- source include/restart_mysqld.inc
